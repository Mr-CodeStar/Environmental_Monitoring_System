<!DOCTYPE html>
<html>
<head>
    <title>Environmental Monitor & Predictor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #eef2f3; }
        #map { flex: 3; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        #sidebar { flex: 1; padding: 25px; background: white; border-left: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; }
        
        h2 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .menu-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { 
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; 
            font-weight: 600; transition: all 0.3s ease; background: #f8f9fa; color: #555;
        }
        .btn.active { background: #3498db; color: white; border-color: #2980b9; }
        
        .stat-card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #eee; border-left: 5px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loading { color: #e67e22; font-weight: bold; padding: 10px; text-align: center; }
        
        #btnPredict {
            display: none; 
            margin-top: 20px; padding: 15px; background: #2ecc71; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2); transition: 0.3s;
        }
        #btnPredict:hover { background: #27ae60; transform: translateY(-2px); }

        canvas { margin-top: 20px; max-width: 100%; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="sidebar">
        <h2>Control Panel</h2>
        
        <div class="menu-buttons">
            <button id="btnMonitor" class="btn active" onclick="setMode('monitor')">Monitor</button>
            <button id="btnDataset" class="btn" onclick="setMode('dataset')">Dataset</button>
        </div>

        <p id="mode-desc" style="color: #7f8c8d; font-size: 0.9em;">Currently in <b>Monitor Mode</b>: Click map to view live indices.</p>
        
        <div id="results">
            <p style="text-align: center; color: #bdc3c7; margin-top: 40px;">Select a location on the map</p>
        </div>

        <hr id="predict-divider" style="display: none;">
        <button id="btnPredict" onclick="runPrediction()">Generate ML Prediction</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentMode = 'monitor';
        let satelliteLayer = null;
        let myChart = null; 
        
        const map = L.map('map').setView([12.97, 77.59], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnMonitor').classList.toggle('active', mode === 'monitor');
            document.getElementById('btnDataset').classList.toggle('active', mode === 'dataset');
            
            document.getElementById('mode-desc').innerHTML = mode === 'monitor' 
                ? "Currently in <b>Monitor Mode</b>: Click map to view live indices." 
                : "Currently in <b>Dataset Mode</b>: Click map to save 5-year CSV.";
            
            const predictBtn = document.getElementById('btnPredict');
            const divider = document.getElementById('predict-divider');
            
            if (mode === 'dataset') {
                predictBtn.style.display = 'block';
                divider.style.display = 'block';
            } else {
                predictBtn.style.display = 'none';
                divider.style.display = 'none';
            }

            document.getElementById('results').innerHTML = '<p style="text-align: center; color: #bdc3c7; margin-top: 40px;">Mode changed. Click map again.</p>';
            
            // Clean up existing visualization and chart when switching modes
            if (satelliteLayer) {
                map.removeLayer(satelliteLayer);
                satelliteLayer = null;
            }
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }
        }

        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            const resultsDiv = document.getElementById('results');
            
            // Clear chart if it exists from a previous run
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }

            if (currentMode === 'monitor') {
                resultsDiv.innerHTML = '<div class="loading">Analyzing Satellite Imagery...</div>';
                try {
                    const res = await fetch(`http://127.0.0.1:8000/api/monitor?lat=${lat}&lon=${lng}`);
                    const json = await res.json();
                    const data = json.data;

                    resultsDiv.innerHTML = `
                        <div class="stat-card"><strong>NDVI (Vegetation)</strong><br>${data.indices.NDVI.toFixed(4)}</div>
                        <div class="stat-card"><strong>NDWI (Moisture)</strong><br>${data.indices.NDWI.toFixed(4)}</div>
                        <div class="stat-card"><strong>LST (Surface Temp)</strong><br>${data.indices.LST.toFixed(2)}°C</div>
                    `;

                    if (satelliteLayer) map.removeLayer(satelliteLayer);
                    satelliteLayer = L.tileLayer(data.tiles.ndvi_heatmap).addTo(map);
                } catch (err) {
                    resultsDiv.innerHTML = '<p style="color:red">Backend connection failed.</p>';
                }
            } else {
                // DATASET MODE
                resultsDiv.innerHTML = '<div class="loading">Fetching map view and extracting 5 years of data...</div>';
                
                try {
                    // 1. Fetch visual tile first so the user sees the "Red Area"
                    const monitorRes = await fetch(`http://127.0.0.1:8000/api/monitor?lat=${lat}&lon=${lng}`);
                    const monitorJson = await monitorRes.json();
                    
                    if (satelliteLayer) map.removeLayer(satelliteLayer);
                    satelliteLayer = L.tileLayer(monitorJson.data.tiles.ndvi_heatmap).addTo(map);

                    // 2. Fetch the 5-year dataset
                    const datasetRes = await fetch(`http://127.0.0.1:8000/api/dataset?lat=${lat}&lon=${lng}&years=5`);
                    const datasetJson = await datasetRes.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="stat-card" style="border-left-color: #2ecc71;">
                            <strong style="color: #27ae60;">CSV Created Successfully!</strong><br>
                            Records: ${datasetJson.total_records} months<br>
                            File: environment_dataset.csv
                        </div>
                        <p style="font-size: 0.8em; color: #7f8c8d;">Visual overlay added. You can now click 'Generate ML Prediction' below.</p>
                    `;
                    
                    document.getElementById('btnPredict').style.display = 'block';
                    document.getElementById('predict-divider').style.display = 'block';
                } catch (err) {
                    resultsDiv.innerHTML = '<p style="color:red">Error during dataset extraction.</p>';
                }
            }
        });

        async function runPrediction() {
            const resultsDiv = document.getElementById('results');
            const predictBtn = document.getElementById('btnPredict');
            const divider = document.getElementById('predict-divider');

            resultsDiv.innerHTML = '<div class="loading">Training Prophet Model & Forecasting...</div>';
            
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/predict?index=NDVI`);
                const json = await res.json();
                
                if (json.status === "success") {
                    predictBtn.style.display = 'none';
                    divider.style.display = 'none';

                    resultsDiv.innerHTML = `
                        <h3>NDVI Forecast (12 Months)</h3>
                        <canvas id="predictionChart"></canvas>
                        <div style="margin-top:10px; font-size: 0.8em; color: #666;">
                            <span style="color: #3498db;">●</span> Historical Data 
                            <span style="color: #2ecc71; margin-left: 10px;">●</span> ML Forecast
                        </div>
                    `;

                    const ctx = document.getElementById('predictionChart').getContext('2d');
                    const history = json.data.history;
                    const future = json.data.future;

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [...history.map(d => d.date), ...future.map(d => d.date)],
                            datasets: [
                                {
                                    label: 'Historical',
                                    data: history.map(d => d.value),
                                    borderColor: '#3498db',
                                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 2
                                },
                                {
                                    label: 'Forecast',
                                    data: [...Array(history.length - 1).fill(null), history[history.length-1].value, ...future.map(d => d.value)],
                                    borderColor: '#2ecc71',
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.3,
                                    pointRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { title: { display: true, text: 'NDVI Value' } },
                                x: { ticks: { maxTicksLimit: 10 } }
                            }
                        }
                    });
                }
            } catch (err) {
                resultsDiv.innerHTML = `<p style="color:red">Prediction failed: ${err.message}</p>`;
                predictBtn.style.display = 'block';
                divider.style.display = 'block';
            }
        }
    </script>
</body>
</html>